<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Test - Kundenstandorte</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    
    <style>
        #map { height: 400px; width: 100%; border: 2px solid #ddd; border-radius: 8px; }
        .error { color: red; font-weight: bold; }
        .success { color: green; font-weight: bold; }
        .warning { color: orange; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1>JavaScript Debug Test - Kundenstandorte</h1>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Test Results</h5>
                    </div>
                    <div class="card-body">
                        <div id="status">Initializing...</div>
                    </div>
                </div>
                
                <div class="card mt-3">
                    <div class="card-header">
                        <h5>Test Actions</h5>
                    </div>
                    <div class="card-body">
                        <button id="testGeocode" class="btn btn-primary me-2">Test Geocoding</button>
                        <button id="testRoute" class="btn btn-success me-2">Test Route Optimization</button>
                        <button id="testMap" class="btn btn-info">Test Map Functions</button>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div id="map"></div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const status = document.getElementById('status');
            let map;
            
            function log(message, type = 'info') {
                const timestamp = new Date().toLocaleTimeString();
                const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : '';
                status.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
                console.log(`[${type.toUpperCase()}] ${message}`);
            }
            
            try {
                // Test 1: Leaflet initialization
                log('Testing Leaflet initialization...');
                map = L.map('map').setView([48.1067, 11.4247], 10);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
                log('✓ Leaflet map initialized successfully', 'success');
                
                // Test 2: Marker creation
                log('Testing marker creation...');
                const hqMarker = L.marker([48.1067, 11.4247]).addTo(map);
                hqMarker.bindPopup('HQ - Planegg, Deutschland');
                log('✓ HQ marker created successfully', 'success');
                
                // Test 3: Fetch API
                log('Testing Fetch API...');
                if (typeof fetch !== 'undefined') {
                    log('✓ Fetch API available', 'success');
                } else {
                    log('✗ Fetch API not available', 'error');
                }
                
                // Test 4: JSON handling
                log('Testing JSON handling...');
                try {
                    const testObj = { test: 'data' };
                    const jsonStr = JSON.stringify(testObj);
                    const parsed = JSON.parse(jsonStr);
                    if (parsed.test === 'data') {
                        log('✓ JSON handling working', 'success');
                    } else {
                        log('✗ JSON handling failed', 'error');
                    }
                } catch (e) {
                    log('✗ JSON handling error: ' + e.message, 'error');
                }
                
                log('Initial tests completed', 'success');
                
            } catch (error) {
                log('✗ Initialization error: ' + error.message, 'error');
                console.error('Initialization error:', error);
            }
            
            // Test geocoding
            document.getElementById('testGeocode').addEventListener('click', async function() {
                log('Testing geocoding API...');
                try {
                    const response = await fetch('/geocode', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify([{ 
                            kundennummer: 'TEST', 
                            adresse: 'Planegg, Deutschland' 
                        }])
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    log('✓ Geocoding API response received', 'success');
                    
                    if (data.results && data.results[0].lat) {
                        const result = data.results[0];
                        log(`✓ Address geocoded: ${result.lat}, ${result.lon}`, 'success');
                        
                        // Add geocoded location to map
                        const geoMarker = L.marker([result.lat, result.lon]).addTo(map);
                        geoMarker.bindPopup(`Geocoded: ${result.adresse}`);
                        
                        // Fit map to show both markers
                        map.fitBounds(L.latLngBounds([[48.1067, 11.4247], [result.lat, result.lon]]));
                        log('✓ Map updated with geocoded location', 'success');
                    } else {
                        log('✗ Geocoding failed - no coordinates returned', 'error');
                    }
                } catch (error) {
                    log('✗ Geocoding error: ' + error.message, 'error');
                    console.error('Geocoding error:', error);
                }
            });
            
            // Test route optimization
            document.getElementById('testRoute').addEventListener('click', async function() {
                log('Testing route optimization API...');
                try {
                    const response = await fetch('/optimize-route', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            locations: [{
                                kundennummer: 'TEST',
                                adresse: 'Planegg, Deutschland',
                                lat: 48.1067,
                                lon: 11.4247
                            }],
                            force_return_to_hq: true
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    log('✓ Route optimization API response received', 'success');
                    
                    if (data.tours && data.tours.length > 0) {
                        const tour = data.tours[0];
                        log(`✓ Route optimized: ${tour.stops.length} stops, ${tour.total_distance} km`, 'success');
                        
                        // Display route on map
                        const routeCoords = tour.stops.map(stop => [stop.location.lat, stop.location.lon]);
                        const routeLine = L.polyline(routeCoords, { color: 'red', weight: 3 });
                        routeLine.addTo(map);
                        
                        // Fit map to show route
                        map.fitBounds(routeLine.getBounds());
                        log('✓ Route displayed on map', 'success');
                    } else {
                        log('✗ Route optimization failed - no tours returned', 'error');
                    }
                } catch (error) {
                    log('✗ Route optimization error: ' + error.message, 'error');
                    console.error('Route optimization error:', error);
                }
            });
            
            // Test map functions
            document.getElementById('testMap').addEventListener('click', function() {
                log('Testing map functions...');
                try {
                    // Test bounds calculation
                    const bounds = map.getBounds();
                    log(`✓ Map bounds: ${bounds.getWest().toFixed(4)}, ${bounds.getSouth().toFixed(4)} to ${bounds.getEast().toFixed(4)}, ${bounds.getNorth().toFixed(4)}`, 'success');
                    
                    // Test zoom
                    const zoom = map.getZoom();
                    log(`✓ Map zoom level: ${zoom}`, 'success');
                    
                    // Test center
                    const center = map.getCenter();
                    log(`✓ Map center: ${center.lat.toFixed(4)}, ${center.lng.toFixed(4)}`, 'success');
                    
                    log('✓ All map functions working', 'success');
                } catch (error) {
                    log('✗ Map function error: ' + error.message, 'error');
                    console.error('Map function error:', error);
                }
            });
        });
    </script>
</body>
</html>
